<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>de.teens phone</title>
    <style>
        :root {
            --primary-red: #ff6b6b;
            --primary-teal: #4ecdc4;
            --bg-light: #f0f0f0;
            --bg-dark: #2d3436;
            --text-light: #333;
            --text-dark: #dfe6e9;
            --card-bg-light: #fff;
            --card-bg-dark: #636e72;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        body {
            font-family: Arial, sans-serif; /* Fallback to a system font */
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--bg-light);
            color: var(--text-light);
            transition: var(--transition);
        }

        body.dark {
            background: var(--bg-dark);
            color: var(--text-dark);
        }

        .container {
            width: 100%;
            max-width: 850px;
            background: var(--card-bg-light);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: var(--transition);
        }

        .container.dark {
            background: var(--card-bg-dark);
        }

        .header {
            background: linear-gradient(90deg, var(--primary-red), var(--primary-teal));
            padding: 15px;
            text-align: center;
            color: #fff;
            font-size: 28px;
            font-weight: 600;
            letter-spacing: 1px;
            position: relative;
        }

        .theme-toggle {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .theme-toggle img {
            width: 20px;
            height: 20px;
            filter: invert(1);
        }

        .lobby, .game-area {
            padding: 25px;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .player-list {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            transition: var(--transition);
        }

        .container.dark .player-list {
            background: rgba(255, 255, 255, 0.1);
        }

        .player {
            padding: 8px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .player:last-child {
            border-bottom: none;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        input[type="text"] {
            padding: 12px;
            border: 2px solid var(--primary-teal);
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: var(--transition);
        }

        input[type="text"]:focus {
            border-color: var(--primary-red);
            box-shadow: 0 0 5px var(--primary-red);
        }

        button {
            padding: 12px 20px;
            background: var(--primary-red);
            color: #fff;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
        }

        button:hover {
            background: #e65b5b;
            transform: scale(1.05);
        }

        .game-area {
            display: none;
        }

        #canvas {
            border: 2px solid var(--primary-teal);
            background: #fff;
            border-radius: 10px;
            box-shadow: var(--shadow);
            margin-bottom: 15px;
            transition: var(--transition);
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .color-picker {
            padding: 5px;
            border: 2px solid var(--primary-teal);
            border-radius: 10px;
            height: 40px;
            width: 40px;
            cursor: pointer;
            transition: var(--transition);
        }

        .color-picker:hover {
            border-color: var(--primary-red);
        }

        #chat {
            height: 150px;
            width: 100%;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.05);
            border: 2px solid var(--primary-teal);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: var(--transition);
        }

        .container.dark #chat {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary-teal);
        }

        .message {
            padding: 8px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            transition: var(--transition);
        }

        .container.dark .message {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        #chatInput {
            width: 70%;
            margin-right: 15px;
        }

        #sendBtn {
            padding: 10px 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--card-bg-light);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: var(--shadow);
            animation: bounceIn 0.5s ease;
            transition: var(--transition);
        }

        .container.dark .modal-content {
            background: var(--card-bg-dark);
        }

        .modal.active {
            display: flex;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            60% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }

        #adminArea {
            display: none; /* Hidden by default */
            margin-top: 15px;
            display: flex;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #adminArea.visible {
            display: flex;
            opacity: 1;
        }

        #nicknameInput {
            display: flex;
            gap: 15px;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            de.teens phone
            <button class="theme-toggle" onclick="toggleTheme()">
                <img src="https://img.icons8.com/ios-glyphs/30/ffffff/sun.png" alt="Theme" id="themeIcon">
            </button>
        </div>
        <div class="lobby" id="lobby">
            <div class="player-list" id="playerList"></div>
            <div id="nicknameInput">
                <input type="text" id="nickname" placeholder="Введіть нік">
                <button id="joinAdminBtn" onclick="promptAdminLogin()">Приєднатись як адмін</button>
                <button id="joinGuestBtn" onclick="joinAsGuest()">Приєднатись як гість</button>
            </div>
        </div>
        <div class="game-area" id="gameArea">
            <canvas id="canvas" width="600" height="400"></canvas>
            <div class="toolbar" id="toolbar" style="display: none;">
                <input type="color" id="colorPicker" class="color-picker" onchange="setColor(this.value)">
                <button onclick="setBrushSize(2)">Small</button>
                <button onclick="setBrushSize(5)">Medium</button>
                <button onclick="setBrushSize(10)">Large</button>
                <button onclick="toggleEraseMode()">Erase</button>
            </div>
            <div id="chat"></div>
            <input type="text" id="chatInput" placeholder="Напишіть ваше повідомлення..." disabled>
            <button id="sendBtn" onclick="sendMessage()" disabled>Надіслати</button>
            <div id="adminArea">
                <input type="text" id="wordInput" placeholder="Enter word to start game">
                <button onclick="startGame()">Start Game</button>
            </div>
        </div>
    </div>
    <div id="gameMessageModal" class="modal">
        <div class="modal-content" id="gameMessageText"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io('http://localhost:8080', { transports: ['websocket'], reconnectionAttempts: 3 });
        let nickname = '';
        let isAdmin = false;
        let gameStarted = false;
        let gameEnded = false;
        let gameActive = false;
        let isDrawing = false;
        let isErasing = false;
        let currentColor = '#000000';
        let brushSize = 2;
        let currentStroke = null;
        let allStrokes = [];
        const canvasBackgroundColor = '#ffffff';

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        function throttle(func, limit) {
            let inThrottle;
            return function (...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => (inThrottle = false), limit);
                }
            };
        }

        socket.on('connect', () => {
            console.log('Connected to server with ID:', socket.id);
            socket.emit('reconnect');
        });

        socket.on('connect_error', (error) => {
            console.error('Connection error:', error.message);
            alert('Failed to connect to server. Ensure it’s running on http://localhost:8080.');
        });

        socket.on('disconnect', (reason) => {
            console.log('Disconnected from server:', reason);
        });

        socket.on('clearCanvas', () => {
            allStrokes = [];
            redrawCanvas();
        });

        socket.on('updateStrokes', (updatedStrokes) => {
            allStrokes = updatedStrokes;
            redrawCanvas();
        });

        function promptAdminLogin() {
            const nick = document.getElementById('nickname').value.trim();
            if (!nick) {
                alert('Please enter a nickname!');
                return;
            }
            nickname = nick;
            const password = prompt("Enter admin password:");
            if (password) {
                socket.emit('adminLogin', { password, nickname });
            } else {
                alert('Password not entered!');
                joinAsGuest();
            }
        }

        socket.on('adminLoginResponse', (data) => {
            if (data.success) {
                isAdmin = true;
                nickname = data.nickname;
                document.getElementById('lobby').style.display = 'none';
                document.getElementById('gameArea').style.display = 'block';
                const adminArea = document.getElementById('adminArea');
                adminArea.classList.add('visible');
                document.getElementById('toolbar').style.display = 'flex';
                socket.emit('join', nickname);
                enableDrawing();
            } else {
                alert('Incorrect password or admin already connected!');
                joinAsGuest();
            }
        });

        function joinAsGuest() {
            const nick = document.getElementById('nickname').value.trim();
            if (!nick) {
                alert('Please enter a nickname!');
                return;
            }
            nickname = nick;
            isAdmin = false;
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            const adminArea = document.getElementById('adminArea');
            adminArea.classList.remove('visible');
            socket.emit('join', nickname);
        }

        socket.on('joinResponse', (data) => {
            if (data.success) {
                enableDrawing();
            } else {
                alert(data.message);
            }
        });

        function startGame() {
            if (!isAdmin) {
                alert('Only the admin can start the game!');
                return;
            }
            const word = document.getElementById('wordInput').value.trim();
            if (!word) {
                alert('Enter a word to start the game!');
                return;
            }
            allStrokes = [];
            redrawCanvas();
            socket.emit('startGame', word);
        }

        function sendMessage() {
            if (!gameActive || gameEnded) {
                alert('Game not active! Wait for the admin to start.');
                return;
            }
            const message = document.getElementById('chatInput').value.trim();
            if (!message) {
                alert('Enter a message!');
                return;
            }
            socket.emit('chatMessage', { message, nickname });
            document.getElementById('chatInput').value = '';
        }

        socket.on('chatMessage', (data) => {
            const chatDiv = document.getElementById('chat');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = data.correct
                ? `${data.nickname} guessed: <strong>${data.message}</strong>`
                : `<strong>${data.nickname}:</strong> ${data.message}`;
            chatDiv.appendChild(messageDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        });

        socket.on('gameStatus', (data) => {
            gameStarted = data.gameStarted;
            gameEnded = data.gameEnded;
            gameActive = gameStarted && !gameEnded;
            document.getElementById('chatInput').disabled = !gameActive;
            document.getElementById('sendBtn').disabled = !gameActive;
        });

        socket.on('gameStarted', () => {
            showCountdownAndStartGame();
        });

        socket.on('gameEnded', (data) => {
            gameEnded = true;
            gameActive = false;
            document.getElementById('chatInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            showGameMessage(`🎉 ${data.winner} guessed the word <strong>${data.word}</strong>! 🎉`);
        });

        function showGameMessage(message) {
            const modal = document.getElementById('gameMessageModal');
            const messageText = document.getElementById('gameMessageText');
            messageText.innerHTML = message;
            modal.classList.add('active');
            setTimeout(() => modal.classList.remove('active'), 5000);
        }

        function showCountdownAndStartGame() {
            let countdown = 3;
            const modal = document.getElementById('gameMessageModal');
            const messageText = document.getElementById('gameMessageText');
            modal.classList.add('active');
            messageText.innerHTML = countdown;
            const interval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    messageText.innerHTML = countdown;
                } else {
                    clearInterval(interval);
                    modal.classList.remove('active');
                    gameActive = true;
                    gameEnded = false;
                    document.getElementById('chatInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                }
            }, 1000);
        }

        function enableDrawing() {
            if (!isAdmin) {
                canvas.style.pointerEvents = 'none';
                return;
            }

            const throttledEmit = throttle((data) => socket.emit('draw', data), 50);

            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                currentStroke = {
                    type: 'stroke',
                    points: [{ x, y }],
                    color: isErasing ? canvasBackgroundColor : currentColor,
                    size: isErasing ? brushSize * 2 : brushSize
                };
                redrawCanvas();
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                currentStroke.points.push({ x, y });
                redrawCanvas();
                throttledEmit(currentStroke);
            });

            canvas.addEventListener('mouseup', () => {
                if (isDrawing && currentStroke.points.length > 1) {
                    allStrokes.push(currentStroke);
                    socket.emit('updateStrokes', allStrokes);
                }
                isDrawing = false;
                currentStroke = null;
            });

            canvas.addEventListener('mouseleave', () => {
                isDrawing = false;
                currentStroke = null;
            });
        }

        function toggleEraseMode() {
            if (!isAdmin) {
                alert('Only the admin can erase!');
                return;
            }
            isErasing = !isErasing;
            const eraseButton = document.querySelector('.toolbar button:last-child');
            eraseButton.textContent = isErasing ? 'Stop Erasing' : 'Erase';
        }

        function setColor(color) {
            currentColor = color;
            isErasing = false;
            const eraseButton = document.querySelector('.toolbar button:last-child');
            eraseButton.textContent = 'Erase';
        }

        function setBrushSize(size) {
            brushSize = size;
            isErasing = false;
            const eraseButton = document.querySelector('.toolbar button:last-child');
            eraseButton.textContent = 'Erase';
        }

        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            allStrokes.forEach(stroke => {
                ctx.strokeStyle = stroke.color;
                ctx.lineWidth = stroke.size;
                ctx.beginPath();
                if (stroke.points.length > 1) {
                    ctx.moveTo(stroke.points[0].x, stroke.points[0].y);
                    for (let i = 1; i < stroke.points.length - 1; i++) {
                        const xc = (stroke.points[i].x + stroke.points[i + 1].x) / 2;
                        const yc = (stroke.points[i].y + stroke.points[i + 1].y) / 2;
                        ctx.quadraticCurveTo(stroke.points[i].x, stroke.points[i].y, xc, yc);
                    }
                    ctx.stroke();
                }
            });
            if (isDrawing && currentStroke && currentStroke.points.length > 1) {
                ctx.strokeStyle = currentStroke.color;
                ctx.lineWidth = currentStroke.size;
                ctx.beginPath();
                ctx.moveTo(currentStroke.points[0].x, currentStroke.points[0].y);
                for (let i = 1; i < currentStroke.points.length - 1; i++) {
                    const xc = (currentStroke.points[i].x + currentStroke.points[i + 1].x) / 2;
                    const yc = (currentStroke.points[i].y + currentStroke.points[i + 1].y) / 2;
                    ctx.quadraticCurveTo(currentStroke.points[i].x, currentStroke.points[i].y, xc, yc);
                }
                ctx.stroke();
            }
        }

        socket.on('draw', (data) => {
            if (!isAdmin) {
                allStrokes.push(data);
                redrawCanvas();
            }
        });

        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function toggleTheme() {
            document.body.classList.toggle('dark');
            const container = document.querySelector('.container');
            container.classList.toggle('dark');
            const themeIcon = document.getElementById('themeIcon');
            themeIcon.src = document.body.classList.contains('dark')
                ? 'https://img.icons8.com/ios-glyphs/30/ffffff/moon-symbol.png'
                : 'https://img.icons8.com/ios-glyphs/30/ffffff/sun.png';
        }
    </script>
</body>
</html>
